<!DOCTYPE html>
<meta charset="utf-8">
<style>

    .content {
        padding: 40px 15px;
    }

    #sequence {
        width: 600px;
        height: 70px;
    }

    #sequence text, #legend text {
        font-weight: 600;
        fill: #fff;
    }

    #chart {
        position: relative;
    }

    #chart path {
        stroke: #fff;
    }

    #explanation {
        position: absolute;
        top: 235px;
        left: 205px;
        width: 140px;
        text-align: center;
        color: #666;
        z-index: -1;
    }

    #percentage {
        font-size: 2.5em;
    }

</style>
<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.2/jquery.min.js"></script>
<script src="//d3js.org/d3.v3.min.js"></script>
<link rel="stylesheet" href="burger.css">
<body>

    <div class="container">
        <div class="content">
            <div id="chart">
                <div id="explanation" style="visibility: hidden;">
                    <span id="percentage"></span><br/>
                    <span id="currentTopic"></span>
                </div>
            </div>
        </div>
    </div>
</body>

<script>
    // Dimensions of sunburst.
    var width = 550;
    var height = 550;
    var radius = Math.min(width, height) / 2;

    // Breadcrumb dimensions: width, height, spacing, width of tip/tail.
    var b = {
        w: 75, h: 30, s: 3, t: 10
    };

    // make `colors` an ordinal scale
    var colors = d3.scale.category20c();

    // Total size of all segments; we set this later, after loading the data.
    var totalSize = 0;

    var vis = d3.select("#chart").append("svg")
        .attr("width", width)
        .attr("height", height)
        .append("g")
        .attr("id", "container")
        .attr("transform", "translate(" + width / 2 + "," + height / 2 + ")");

    var x = d3.scale.linear()
        .range([0, 2 * Math.PI]);

    var y = d3.scale.sqrt()
        .range([0, radius]);

    var partition = d3.layout.partition()
        .value(function(d) { return d.size; });

    var arc = d3.svg.arc()
        .startAngle(function(d) { return Math.max(0, Math.min(2 * Math.PI, x(d.x))); })
        .endAngle(function(d) { return Math.max(0, Math.min(2 * Math.PI, x(d.x + d.dx))); })
        .innerRadius(function(d) { return Math.max(0, y(d.y)); })
        .outerRadius(function(d) { return Math.max(0, y(d.y + d.dy)); });

    json = getData();
    createVisualization(json);


    // Main function to draw and set up the visualization, once we have the data.
    function createVisualization(json) {

        // Basic setup of page elements.
        initializeBreadcrumbTrail();

        // Bounding circle underneath the sunburst, to make it easier to detect
        // when the mouse leaves the parent g.
        vis.append("circle")
            .attr("r", radius)
            .style("opacity", 0);

        // For efficiency, filter nodes to keep only those large enough to see.
        var nodes = partition.nodes(json);


        var uniqueNames = (function(a) {
            var output = [];
            a.forEach(function(d) {
                if (output.indexOf(d.name) === -1) {
                    output.push(d.name);
                }
            });
            return output;
        })(nodes);

        // set domain of colors scale based on data
        colors.domain(uniqueNames);

        var path = vis.data([json]).selectAll("path")
            .data(nodes)
            .enter()
            .append("path")
            .attr("display", function(d) { return d.depth ? null : "none"; })
            .attr("d", arc)
            .attr("fill-rule", "evenodd")
            .style("fill", function(d) { return colors(d.name); })
            .style("opacity", 1)
            .on("mouseover", mouseover);

        // Add the mouseleave handler to the bounding circle.
        d3.select("#container").on("mouseleave", mouseleave);

        // Get total size of the tree = value of root node from partition.
        totalSize = path.node().__data__.value;
    };

    // Fade all but the current sequence, and show it in the breadcrumb trail.
    function mouseover(d) {

        var percentage = (100 * d.value / totalSize).toPrecision(3);
        var percentageString = percentage + "%";
        if (percentage < 0.1) {
            percentageString = "< 0.1%";
        }

        d3.select("#percentage")
            .text(percentageString);

        d3.select("#currentTopic").text(d.name);

        d3.select("#explanation")
            .style("visibility", "");

        var sequenceArray = getAncestors(d);
        updateBreadcrumbs(sequenceArray, percentageString);

        // Fade all the segments.
        d3.selectAll("path")
            .style("opacity", 0.3);

        // Then highlight only those that are an ancestor of the current segment.
        vis.selectAll("path")
            .filter(function(node) {
                return (sequenceArray.indexOf(node) >= 0);
            })
            .style("opacity", 1);
    }

    // Restore everything to full opacity when moving off the visualization.
    function mouseleave(d) {

        // Hide the breadcrumb trail
        d3.select("#trail")
            .style("visibility", "hidden");

        // Deactivate all segments during transition.
        d3.selectAll("path").on("mouseover", null);

        // Transition each segment to full opacity and then reactivate it.
        d3.selectAll("path")
            .transition()
            .duration(1000)
            .style("opacity", 1)
            .each("end", function() {
                d3.select(this).on("mouseover", mouseover);
            });

        d3.select("#explanation")
            .transition()
            .duration(1000)
            .style("visibility", "hidden");
    }

    // Given a node in a partition layout, return an array of all of its ancestor
    // nodes, highest first, but excluding the root.
    function getAncestors(node) {
        var path = [];
        var current = node;
        while (current.parent) {
            path.unshift(current);
            current = current.parent;
        }
        return path;
    }

    function initializeBreadcrumbTrail() {
        // Add the svg area.
        var trail = d3.select("#sequence").append("svg")
            .attr("width", width)
            .attr("height", 50)
            .attr("id", "trail");
        // Add the label at the end, for the percentage.
        trail.append("text")
            .attr("id", "endlabel")
            .style("fill", "#000");
    }


    // Generate a string that describes the points of a breadcrumb polygon.
    function breadcrumbPoints(d, i) {
        var points = [];
        points.push("0,0");
        points.push(b.w + ",0");
        points.push(b.w + b.t + "," + (b.h / 2));
        points.push(b.w + "," + b.h);
        points.push("0," + b.h);
        if (i > 0) { // Leftmost breadcrumb; don't include 6th vertex.
            points.push(b.t + "," + (b.h / 2));
        }
        return points.join(" ");
    }

    // Update the breadcrumb trail to show the current sequence and percentage.
    function updateBreadcrumbs(nodeArray, percentageString) {

        // Data join; key function combines name and depth (= position in sequence).
        var g = d3.select("#trail")
            .selectAll("g")
            .data(nodeArray, function(d) { return d.name + d.depth; });

        // Add breadcrumb and label for entering nodes.
        var entering = g.enter().append("g");

        entering.append("polygon")
            .attr("points", breadcrumbPoints)
            .style("fill", function(d) { return colors(d.name); });

        entering.append("text")
            .attr("x", (b.w + b.t) / 2)
            .attr("y", b.h / 2)
            .attr("dy", "0.35em")
            .attr("text-anchor", "middle")
            .text(function(d) { return d.name; });

        // Set position for entering and updating nodes.
        g.attr("transform", function(d, i) {
            return "translate(" + i * (b.w + b.s) + ", 0)";
        });

        // Remove exiting nodes.
        g.exit().remove();

        // Now move and update the percentage at the end.
        d3.select("#trail").select("#endlabel")
            .attr("x", (nodeArray.length + 0.5) * (b.w + b.s))
            .attr("y", b.h / 2)
            .attr("dy", "0.35em")
            .attr("text-anchor", "middle")
            .text(percentageString);

        // Make the breadcrumb trail visible, if it's hidden.
        d3.select("#trail")
            .style("visibility", "");

    }

    function getData() {
        return {
            "name": "2007",
            "children": [
                {"name": "Einnahmen",
                    "children": [
                        {"name": "Ertrag",
                            "children": [
                                {"name": "Fiskalertrag",
                                    "children": [
                                        {"name": "Direkte Bundessteuer",
                                            "children": [
                                                {"name": "Steuer auf Reingewinn juristischer Personen", "size": 6860036346.000},
                                                {"name": "Steuer auf Einkommen natürlicher Personen", "size": 8528864409.910}
                                            ]
                                        },
                                        {"name": "Verrechnungssteuer",
                                            "children": [
                                                {"name": "Verrechnungssteuer (Schweiz)", "size": 2710501973.540},
                                                {"name": "Steuerrückbehalt USA", "size": 19402362.780}
                                            ]
                                        },
                                        {"name": "Stempelabgaben",
                                            "children": [
                                                {"name": "Emissionsabgabe", "size": 405076103.210},
                                                {"name": "Umsatzabgabe", "size": 1939932780.450},
                                                {"name": "Prämienquittungsstempel und Übrige", "size": 644546345.520}
                                            ]
                                        },
                                        {"name": "Mehrwertsteuer",
                                            "children": [
                                                {"name": "Allgemeine Bundesmittel", "size": 15958549078.800},
                                                {"name": "Zweckgebundene Mittel", "size": 3725919467.270}
                                            ]
                                        },
                                        {"name": "Übrige Verbrauchssteuern",
                                            "children": [
                                                {"name": "Tabaksteuer", "size": 2186396807.000},
                                                {"name": "Biersteuer", "size": 107155215.000},
                                                {"name": "Spirituosensteuer", "size": 0},
                                                {"name": "Mineralölsteuer", "size": 5086218541.000},
                                                {"name": "Netzzuschlag", "size": 0}
                                            ]
                                        },
                                        {"name": "Verkehrsabgaben",
                                            "children": [
                                                {"name": "Automobilsteuer", "size": 357991792.000},
                                                {"name": "Nationalstrassenabgabe", "size": 321663541.610},
                                                {"name": "Schwerverkehrsabgabe", "size": 1336369578.000}
                                            ]
                                        },
                                        {"name": "Zölle", "size": 1040330743.000},
                                        {"name": "Spielbankenabgaben", "size": 448595989.240},
                                        {"name": "Lenkungsabgaben",
                                            "children": [
                                                {"name": "Lenkungsabgabe VOC", "size": 126738996.000},
                                                {"name": "Lenkungsabgaben Heizöl, Benzin und Dieselöl", "size": 401472.000},
                                                {"name": "Altlastenabgabe", "size": 28452744.900},
                                                {"name": "Lenkungsabgabe CO2", "size": 0}
                                            ]
                                        },
                                        {"name": "Übriger Fiskalertrag", "size": 3135154.800}
                                    ]
                                },
                                {"name": "Regalien und Konzessionen",
                                    "children": [
                                        {"name": "Anteil am Reingewinn der Alkoholverwaltung", "size": 222721557.000},
                                        {"name": "Gewinnausschüttung SNB", "size": 833333333.000},
                                        {"name": "Übrige Erträge aus Regalien und Konzessionen", "size": 274480856.550}
                                    ]
                                },
                                {"name": "Entgelte",
                                    "children": [
                                        {"name": "Wehrpflichtersatzabgabe", "size": 137956411.200},
                                        {"name": "Gebühren", "size": 291206334.250},
                                        {"name": "Entgelte für Benutzungen und Dienstleistungen", "size": 73298960.930},
                                        {"name": "Verkäufe", "size": 196217286.870},
                                        {"name": "Rückerstattungen", "size": 112653377.040},
                                        {"name": "EU Zinsbesteuerung", "size": 120761811.390},
                                        {"name": "Übrige Entgelte", "size": 455012220.420}
                                    ]
                                },
                                {"name": "Verschiedener Ertrag",
                                    "children": [
                                        {"name": "Liegenschaftenertrag", "size": 315464642.950},
                                        {"name": "Gewinne auf Sach- und immateriellen Anlagen", "size": 58177755.840},
                                        {"name": "Erträge aus Drittmitteln und Kofinanzierungen", "size": 0},
                                        {"name": "Aktivierungen", "size": 22600435.380},
                                        {"name": "Übernahme Nationalstrassen", "size": 0},
                                        {"name": "Übriger verschiedener Ertrag", "size": 60513417.940}
                                    ]
                                },
                                {"name": "Finanzertrag",
                                    "children": [
                                        {"name": "Zinsertrag", "size": 689662677.140},
                                        {"name": "Kursgewinne", "size": 96448940.650},
                                        {"name": "Beteiligungsertrag", "size": 884397.400},
                                        {"name": "Gewinne auf Darlehen und Beteiligungen", "size": 1530000.000},
                                        {"name": "Zunahme von Equitywerten", "size": 1859977241.280},
                                        {"name": "Verschiedener Finanzertrag", "size": 320389698.690}
                                    ]
                                },
                                {"name": "Einnahme aus zweckgebundenen Fonds im FK", "size": 20613454.100},
                                {"name": "Ausserordentlicher Ertrag", "size": 629651753.070}
                            ]
                        },
                        {"name": "Investitionseinnahmen",
                            "children": [
                                {"name": "Veräusserung von Sachanlagen", "size": 74400410.130},
                                {"name": "Veräusserung immaterielle Anlagen", "size": 0},
                                {"name": "Rückzahlung Darlehen", "size": 289461687.740},
                                {"name": "Veräusserung Beteiligungen", "size": 885000.000},
                                {"name": "Rückzahlung eigener Investitionsbeiträge", "size": 218861.090},
                                {"name": "Durchlaufende Investitionsbeiträge", "size": 0},
                                {"name": "Ausserordentliche Investitionseinnahmen", "size": 754310554.350}
                            ]
                        }
                    ]
                },
                {"name": "Ausgaben nach Aufgabengebiet",
                    "children": [
                        {"name": "Institutionelle und finanzielle Voraussetzungen",
                            "children": [
                                {"name": "Unterstützung Legislative und Exekutive", "size": 270610124.380},
                                {"name": "Steuerpolitik", "size": 535646955.130},
                                {"name": "Ressourcen- und Verwaltungssteuerung", "size": 110456201.330},
                                {"name": "Interne Dienstleistungen", "size": 1004556451.700},
                                {"name": "Auswertung und Erhebung von Daten", "size": 229430454.450}
                            ]
                        },
                        {"name": "Ordnung und öffentliche Sicherheit",
                            "children": [
                                {"name": "Allgemeines Rechtswesen", "size": 78079725.490},
                                {"name": "Polizei, Strafverfolgung und -vollzug, Nachrichtendienst", "size": 311293880.680},
                                {"name": "Grenzkontrollen", "size": 282057113.640},
                                {"name": "Gerichte", "size": 141426100.840}
                            ]
                        },
                        {"name": "Beziehungen zum Ausland - Internationale Zusammenarbeit",
                            "children": [
                                {"name": "Politische Beziehungen", "size": 535133715.170},
                                {"name": "Entwicklungshilfe (Süd- und Ostländer)", "size": 1637062318.600},
                                {"name": "Wirtschaftliche Beziehungen", "size": 71454195.610},
                                {"name": "Hilfe an Ostländer und Erweiterung der EU", "size": 29989878.420}
                            ]
                        },
                        {"name": "Landesverteidigung",
                            "children": [
                                {"name": "Militärische Landesverteidigung", "size": 4231202775.880},
                                {"name": "Bevölkerungsschutz und Zivildienst", "size": 106578871.960}
                            ]
                        },
                        {"name": "Bildung und Forschung",
                            "children": [
                                {"name": "Berufsbildung", "size": 518180800.710},
                                {"name": "Hochschulen", "size": 1563778495.090},
                                {"name": "Grundlagenforschung", "size": 1834315243.350},
                                {"name": "Angewandte Forschung", "size": 1001702407.370},
                                {"name": "Übriges Bildungswesen", "size": 59763368.580}
                            ]
                        },
                        {"name": "Kultur und Freizeit",
                            "children": [
                                {"name": "Kulturerhaltung", "size": 94051521.950},
                                {"name": "Kulturförderung", "size": 123433454.650},
                                {"name": "Sport", "size": 140200766.590},
                                {"name": "Medienpolitik", "size": 101919604.680}
                            ]
                        },
                        {"name": "Gesundheit", "size": 264116029.930},
                        {"name": "Soziale Wohlfahrt",
                            "children": [
                                {"name": "Altersversicherung", "size": 7984391072.290},
                                {"name": "Invalidenversicherung", "size": 4492450766.840},
                                {"name": "Krankenversicherung", "size": 2262787658.450},
                                {"name": "Ergänzungsleistungen", "size": 711171838.100},
                                {"name": "Militärversicherung", "size": 231633257.360},
                                {"name": "Arbeitslosenversicherung / Arbeitsvermittlung", "size": 302099229.600},
                                {"name": "Sozialer Wohnungsbau / Wohnbauförderung", "size": 109523262.920},
                                {"name": "Migration", "size": 791099659.470},
                                {"name": "Familienpolitik, Gleichstellung", "size": 48093970.590}
                            ]
                        },
                        {"name": "Verkehr",
                            "children": [
                                {"name": "Strassenverkehr", "size": 2751355606.030},
                                {"name": "Schienenverkehr und öffentlicher Verkehr", "size": 4507226836.790},
                                {"name": "Luftfahrt", "size": 89944308.470}
                            ]
                        },
                        {"name": "Umwelt und Raumordnung",
                            "children": [
                                {"name": "Umwelt", "size": 319942631.230},
                                {"name": "Schutz vor Naturgefahren", "size": 255788090.010},
                                {"name": "Naturschutz", "size": 107248808.370},
                                {"name": "Raumordnung", "size": 12165454.210}
                            ]
                        },
                        {"name": "Landwirtschaft und Ernährung", "size": 3601158498.200},
                        {"name": "Wirtschaft",
                            "children": [
                                {"name": "Wirtschaftsordnung", "size": 147874544.170},
                                {"name": "Standortförd., Regionalpolitik, wirtsch. Landesversorgung", "size": 128861465.530},
                                {"name": "Energie", "size": 80691274.660}
                            ]
                        },
                        {"name": "Finanzen und Steuern",
                            "children": [
                                {"name": "Anteile an Bundeseinnahmen", "size": 5750456469.640},
                                {"name": "Geldbeschaffung, Vermögens- und Schuldenverwaltung", "size": 4002706515.920},
                                {"name": "Finanzausgleich", "size": 0}
                            ]
                        }
                    ]
                }
            ]
        };
    };
</script>
